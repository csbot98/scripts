# ELK-IBM SOAR Connector

### <h3 align="right">(_Hun_)
## <u>Leírás</u>
A script API-hívással lekérdezi az Elasticsearch rendszerből azokat az indexeket, amelyek a SIEM korrelációs szabályok által generált alerteket tartalmazzák, a megadott query feltételei alapján. Az így lekért alertek JSON formátumban érkeznek.

A releváns adatok alapján a script egy payload-ot állít össze, amelyet továbbít az IBM SOAR rendszer felé, ahol ebből incidens jön létre.

Fontos viselkedési logika:
* Csak a főalertből jön létre tényleges Incidens.
* A főalerthez tartozó alalertek külön-külön Data Table sorokként kerülnek az Incidenshez rögzítésre a SOAR-ban.

### <u>Főbb funkciók:</u>
<b>__</b>
► <b>_Lekérdezés szűrése és ellenőrzése:_</b>
A script csak azokat az indexeket dolgozza fel, amelyek megfelelnek az előre definiált feltételeknek: például ha a SIEM szabály neve meghatározott prefixet tartalmaz, vagy ha az esemény „tags” mezőjében szerepel egy megadott címke.

► <b>_Artifact-ok kezelése:_</b>
Az észlelt riasztásokból automatikusan kinyeri az artifact-okat, és azokat hozzáadja a létrehozandó SOAR incidenshez – megfelelő mezők szerint kategorizálva.

► <b>_Data Table integráció:_</b>
A kapcsolódó eseményeket az incidenshez tartozó Data Table-ben rögzíti. Például SSH Brute Force esetén csak egy incidens jön létre, viszont a Data Table-ben minden kapcsolódó próbálkozás külön sorban jelenik meg.

► <b>_Duplikációk kizárása_</b>
Az esetleges ismétlődő incidens létrehozás elkerülése érdekében a script összeveti az új riasztások „alert.id” és „group.id” értékeit a SOAR rendszerben már meglévő incidensekével.

► <b>_Lokális ID-tárolás:_</b>
A lekérdezett riasztások „group.id” értékeit a script lokálisan tárolja egy változóban, így csökkentve a felesleges lekérdezéseket az Elasticsearch vagy a SOAR felé. (Megjegyzés: jelenleg csak a „group.id” mentése van implementálva – az „alert.id” tárolása a következő verzióban lesz elérhető.)

► <b>_Debug mód és naplózás:_</b>
Részletes naplózás történik minden fontos műveletről: normál üzemmódban csak lényegi információk kerülnek naplózásra, míg debug módban részletes kimenet jelenik meg a konzolon. Hiba esetén a logfájlba kerül mentés. A send_to_soar kapcsoló segítségével a SOAR felé történő küldés külön is ki- és bekapcsolható, pl. tesztelés céljából.
(Megjegyzés: a SOAR-ba küldendő payload fájlba mentése még nem teljes körű – jelenleg alacsonyabb prioritással bír.)

► <b>_Microsoft Teams riport:_</b>
A script minden nap 09:00-kor automatikusan küld egy összefoglaló Teams-üzenetet webhookon keresztül. A riport tartalmazza a sikeres/sikertelen incidensküldések számát, valamint a létrehozott Artifact-ok és Data Table sorok mennyiségét.

► <b>_E-mail riport:_</b>
Hasonlóan a Teams riporthoz, HTML-formázott e-mail érkezik a rendszer állapotáról és eredményeiről.

► <b>_Aszinkron működés:_</b>
A script kulcsfontosságú részei aszinkron módon futnak, lehetővé téve több riasztás párhuzamos feldolgozását. Ez jelentősen növeli a feldolgozás sebességét és hatékonyságát.

### <u>Követelmények és feltételek:</u>
* #### _Python modulok:_
>base64, json, datetime, aiohttp, asyncio, requests, elasticsearch8*, re, os, smtplib, logging, sys,
email.mime.text.MIMEText, email.mime.multipart.MIMEMultipart

* #### _Külső hozzáférések:_
> Elasticsearch API  <br> IBM SOAR API

* #### _Futtatási jogosultság:_
> A script és a hozzá tartozó logfájlok létrehozásához megfelelő rendszerjogosultság szükséges (pl. írási jog a log könyvtárba).

* #### _Javasolt futtatási mód:_
>Platform: Linux <br> Futtatás: <b>Cronjob</b> segítségével időzítve (10 perceként). <br> A futtatás kimenetét javasolt egy fájlba irányítani (<b>>> script.log 2>&1</b>).

---
### <h3 align="right">(_Eng_)
## <u>Desc.</u>

The script uses an API call to query Elasticsearch for indices that contain alerts generated by SIEM correlation rules, based on a specified query.

The retrieved alerts are in JSON format. From the relevant fields, the script builds a payload and sends it to the IBM SOAR platform, where it creates a new incident.

Key logic behavior:
* An actual incident is only created from the main/root alert.
* Any sub-alerts related to the main alert are passed to the incident as separate Data Table rows within SOAR.

### <u>Main functions:</u>
► <b>_Query Filtering & Validation:_</b>
The script processes only those indices that match specific conditions — for example, if the triggered SIEM rule has a specific prefix or if the event contains a predefined tag in its tags field.

► <b>_Artifact Extraction:_</b>
Extracts artifacts from each alert and attaches them to the generated SOAR incident in the appropriate format.

► <b>_Data Table Integration:_</b>
Related sub-events are added as rows to the SOAR incident’s Data Table.
Example: In the case of an SSH Brute Force attack, only one incident is created, but all associated attempts are listed in the Data Table.

► <b>_Duplicate Prevention:_</b>
To avoid duplicate incident creation, the script compares the alert.id and/or group.id values of incoming alerts against existing incidents in SOAR.

► <b>_Local ID Storage:_</b>
The group.id values of queried alerts are stored locally in a variable to avoid redundant queries to Elasticsearch and SOAR. New IDs are appended, not overwritten, to optimize performance.
Note: Currently only group.id is stored; alert.id local storage is planned for a future version to further reduce SOAR load.

► <b>_Debug Mode & Logging:_</b>
The script logs essential actions and errors. When debug mode is enabled, more detailed operational logs are printed to the console.
The send_to_soar flag allows enabling/disabling communication with SOAR — useful during testing.
Note: Writing the payload to a file before sending it to SOAR is not fully implemented yet, as other features have higher priority.

► <b>_Microsoft Teams Reporting:_</b>
The script sends a daily status message at 09:00 via a Teams webhook, summarizing successful/failed incident generations, and the number of processed Artifacts and Data Table rows.

► <b>_Email Reporting:_</b>
In addition to Teams, the script sends a daily summary email in HTML format, with similar statistics.

► <b>_Asynchronous Processing:_</b>
Core functionality is implemented using asyncio, allowing the script to process multiple alerts in parallel for faster and more efficient execution.

### <u>Requirements & Prerequisites:</u>
* #### _Required Python Modules:k:_
>base64, json, datetime, aiohttp, asyncio, requests, elasticsearch8*, re, os, smtplib, logging, sys,
email.mime.text.MIMEText, email.mime.multipart.MIMEMultipart

* #### _External Access Needed::_
> Elasticsearch API  <br> IBM SOAR API

* #### _Permissions:_
> Sufficient OS permissions to execute the script and write log files (e.g., access to log directory).

* #### _Recommended Execution Setup:_
>Platform: Linux <br> Execution method: Set up using cron to run at regular intervals (e.g., every 5–10 minutes). <br> Logging: Redirect script output to a log file (e.g., <b>>> script.log 2>&1</b>).
